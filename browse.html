<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Browser</title>
  <link rel="stylesheet" href="./stuff.css" />
  <script src="/uv/uv.bundle.js"></script>
  <script src="/uv/uv.config.js"></script>
  <script src="/envade/en.config.js"></script>
  <script src="/envade/en.bundle.js"></script>
  <script src="/scramjet/scramjet.controller.js"></script>
  <script src="/baremux/index.js"></script>
</head>
<body style="margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center;">
  <input type="text" id="search" placeholder="Search for a game..." style="margin: 20px; padding: 10px; width: 60%;" />
  <div id="results" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; overflow-y: auto; height: 80vh;"></div>

  <script>
    const px = localStorage.getItem("sproxy") || "uv";
    const scramjet = new ScramjetController({
      prefix: "/service/scramjet/",
      files: {
        wasm: "/scramjet/scramjet.wasm.wasm",
        worker: "/scramjet/scramjet.worker.js",
        client: "/scramjet/scramjet.client.js",
        shared: "/scramjet/scramjet.shared.js",
        sync: "/scramjet/scramjet.sync.js"
      }
    });

    const encodeProxyUrl = (url) => {
      switch (px) {
        case "uv":
          return window.__uv$config.prefix + window.__uv$config.encodeUrl(url);
        case "envade":
          return window.__envade$config.prefix + window.__envade$config.codec.encode(url);
        case "scramjet":
          return scramjet.encodeUrl?.(url) || url;
        default:
          return url;
      }
    };

    const init = async () => {
      const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
      const wisp = location.origin.includes("8080")
        ? `${location.protocol === "http:" ? "ws:" : "wss:"}//${location.host}/wisp/`
        : "wss://wisp.terbiumon.top/wisp/";
      try {
        await connection.setTransport("/epoxy/index.mjs", [{ wisp }]);
      } catch {
        const fallback = localStorage.getItem("bare-mux-path");
        if (fallback) {
          try {
            await import(fallback);
          } catch (e) {
            console.error("localstorage baremux failed:", e);
          }
        }
      }
      await scramjet.init();

      const results = document.getElementById("results");

      const render = (games) => {
        results.innerHTML = "";
        for (const game of games) {
          const card = document.createElement("div");
          card.style.border = "1px solid black";
          card.style.padding = "10px";
          card.style.width = "180px";
          card.style.display = "flex";
          card.style.flexDirection = "column";
          card.style.alignItems = "center";

          const img = document.createElement("img");
          img.src = encodeProxyUrl(game.img);
          img.style.width = "100%";

          const title = document.createElement("div");
          title.textContent = game.title;
          title.style.fontWeight = "bold";
          title.style.margin = "5px 0";

          card.onclick = () => {
            const params = new URLSearchParams();
            params.set("id", game.link.split("/").pop().replace("/index.html", ""));
            params.set("proxy", px);
            params.set("title", game.title);
            params.set("desc", game.description);
            params.set("link", game.link);
            params.set("img", game.img);
            location.href = "/game.html?" + params.toString();
          };

          card.appendChild(img);
          card.appendChild(title);
          results.appendChild(card);
        }
      };

      const loadTop = async () => {
        const encoded = encodeProxyUrl(`${location.origin}/g.json`);
        const res = await fetch(encoded);
        const json = await res.json();
        render(json);
      };

      const searchInput = document.getElementById("search");
      searchInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          const query = encodeURIComponent(searchInput.value);
          const apiURL = encodeProxyUrl(`https://api.s16.lol/v0/api/games/q=${query}`);
          try {
            const res = await fetch(apiURL);
            const data = await res.json();
            render(data);
          } catch (err) {
            console.error("Search failed", err);
          }
        }
      });

      loadTop();
    };

    init();
  </script>
</body>
</html>
