<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Player</title>
  <link rel="stylesheet" href="./stuff.css" />
  <script src="/uv/uv.bundle.js"></script>
  <script src="/uv/uv.config.js"></script>
  <script src="/envade/en.config.js"></script>
  <script src="/envade/en.bundle.js"></script>
  <script src="/scramjet/scramjet.controller.js"></script>
  <script src="/baremux/index.js"></script>
</head>
<body style="margin:0; padding:0; display:flex; flex-direction:column; align-items:center;">

  <div style="margin: 10px; text-align: center;">
    <h2 id="title"></h2>
    <img id="image" style="width: 120px; height: 120px;" />
    <p id="desc"></p>
    <button id="playBtn">▶ Play</button>
    <button id="reloadBtn">⟳ Reload</button>
    <button id="fsBtn">⛶ Fullscreen</button>
  </div>

  <iframe id="iframe" style="width:100%; height:70vh; border:none;"></iframe>

  <script>
    const getparam = (k) => new URLSearchParams(location.search).get(k);
    const title = getparam("title");
    const img = getparam("img");
    const desc = getparam("desc");
    const rawLink = getparam("link");
    const px = getparam("proxy") || localStorage.getItem("sproxy") || "uv";
    const iframe = document.getElementById("iframe");

    const scramjet = new ScramjetController({
      prefix: "/service/scramjet/",
      files: {
        wasm: "/scramjet/scramjet.wasm.wasm",
        worker: "/scramjet/scramjet.worker.js",
        client: "/scramjet/scramjet.client.js",
        shared: "/scramjet/scramjet.shared.js",
        sync: "/scramjet/scramjet.sync.js"
      }
    });

    const encodeProxyUrl = (url) => {
      switch (px) {
        case "uv":
          return window.__uv$config.prefix + window.__uv$config.encodeUrl(url);
        case "envade":
          return window.__envade$config.prefix + window.__envade$config.codec.encode(url);
        case "scramjet":
          return scramjet.encodeUrl?.(url) || url;
        default:
          return url;
      }
    };

    const load = async () => {
      const connection = new BareMux.BareMuxConnection("/baremux/worker.js");
      const wisp = location.origin.includes("8080")
        ? `${location.protocol === "http:" ? "ws:" : "wss:"}//${location.host}/wisp/`
        : "wss://wisp.terbiumon.top/wisp/";
      try {
        await connection.setTransport("/epoxy/index.mjs", [{ wisp }]);
      } catch {
        const fallback = localStorage.getItem("baremux");
        if (fallback) {
          try {
            await import(fallback);
          } catch (e) {
            console.error("localstorage baremux failed:", e);
          }
        }
      }

      await scramjet.init();

      document.getElementById("title").textContent = title;
      document.getElementById("image").src = encodeProxyUrl(img);
      document.getElementById("desc").textContent = desc;

      const encoded = encodeProxyUrl(rawLink);
      document.getElementById("playBtn").onclick = () => {
        iframe.src = encoded;
      };
      document.getElementById("reloadBtn").onclick = () => {
        iframe.src = encoded;
      };
      document.getElementById("fsBtn").onclick = () => {
        if (iframe.requestFullscreen) iframe.requestFullscreen();
      };
    };

    load();
  </script>
</body>
</html>
